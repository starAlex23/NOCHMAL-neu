<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zeiterfassung</title>
  <style>
   body {
  font-family: 'Inter', sans-serif;
  margin: 0; padding: 0;
  background: var(--bg, #fff);
  color: var(--fg, #000);
  font-size: 16px;
  line-height: 1.5;
}
  

[data-theme="dark"] {
  --bg: #121212;
  --fg: #eee;
}

header {
  background: #4CAF50;
  color: white;
  padding: 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 1.2rem;
}

main {
  max-width: 100%;
  margin: 0 auto;
  padding: 1rem;
  box-sizing: border-box;
}

.card {
  background: var(--card-bg, #f9f9f9);
  padding: 1rem;
  margin-bottom: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
}

[data-theme="dark"] .card {
  --card-bg: #222;
}

.hidden {
  display: none !important;
}

label {
  display: block;
  margin-top: 1rem;
  font-weight: 500;
}

input[type="email"],
input[type="password"],
input[type="text"] {
  width: 100%;
  padding: 0.8rem;
  margin-top: 0.4rem;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1rem;
  box-sizing: border-box;
}

button {
  display: block;
  width: 100%;
  margin-top: 1.2rem;
  padding: 0.9rem;
  font-size: 1.05rem;
  border-radius: 6px;
  background: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
  transition: background 0.2s ease;
}

button:hover {
  background: #45a049;
}

button:disabled {
  background: #999;
  cursor: not-allowed;
}

.link {
  text-align: center;
  margin-top: 1rem;
}

.link button {
  background: none;
  border: none;
  color: #4CAF50;
  text-decoration: underline;
  font-size: 1rem;
  padding: 0.4rem;
}

#theme-switcher {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  font-size: 2rem;
  background: none;
  border: none;
  cursor: pointer;
}

#popup-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: var(--color-bg-popup, #222);
  color: var(--color-text-popup, #eee);
  padding: 1.5rem 2rem;
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(0,0,0,0.7);
  font-size: 1.2rem;
  z-index: 10000;
  opacity: 0.95;
  transition: opacity 0.3s ease;
  pointer-events: none;
  max-width: 90%;
  text-align: center;
}

#popup-message.hidden {
  display: none;
  opacity: 0;
  pointer-events: none;
}

/* Optional: Media-Query f√ºr sehr kleine Ger√§te */
@media (max-width: 360px) {
  header h1 {
    font-size: 1.1rem;
  }

  button {
    font-size: 0.95rem;
    padding: 0.75rem;
  }

  label {
    font-size: 0.95rem;
  }

  input {
    font-size: 0.95rem;
  }
}
  </style>
</head>
  
  

</body>


<header role="banner"> 
  <h1>Zeiterfassung</h1>
</header>

<main role="main" aria-live="polite">

  <!-- 1. QR Code Scanner -->
  <section id="qr-section" class="card" aria-label="QR Code Scanner">
    <h2>QR-Code scannen</h2>
    <div id="qr-reader" style="width:100%"></div>
    <p id="qr-message"></p>
  </section>

  <!-- 2. Login -->
<section id="login-section" class="card hidden" aria-label="Login Formular">
  <h2>Login</h2>
  <form id="login-form" novalidate>
    <label for="login-email">E-Mail</label>
    <input type="email" id="login-email" name="email" required autocomplete="email" />

    <label for="login-password">Passwort</label>
<input type="password" id="login-password" name="passwort" required autocomplete="current-password" />


    <button id="activate-biometric" type="button">üîê Biometrie aktivieren</button>

    <button type="submit">Einloggen</button>
  </form>
  <div class="link">
    Noch keinen Account? <button id="show-register-btn" type="button">Jetzt registrieren</button>
  </div>
  
  <p id="login-error" class="error-message"></p>
</section>


  <!-- 3. Registrierung -->
  <section id="register-section" class="card hidden" aria-label="Registrierung Formular">
    <h2>Registrieren</h2>
    <form id="register-form" novalidate>
      <label for="register-firstname">Vorname</label>
      <input type="text" id="register-firstname" name="firstname" required autocomplete="given-name" />
      
      <label for="register-lastname">Nachname</label>
      <input type="text" id="register-lastname" name="lastname" required autocomplete="family-name" />

      <label for="register-email">E-Mail</label>
      <input type="email" id="register-email" name="email" required autocomplete="email" />

      <label for="register-password">Passwort</label>
      <input type="password" id="register-password" name="password" required autocomplete="new-password" />

      <button type="submit">Registrieren</button>
    </form>
    <div class="link">
      Schon einen Account? <button id="show-login-btn" type="button">Jetzt einloggen</button>
    </div>

<div id="logout-message"></div>

    
    <button id="registerWebAuthn" type="button">WebAuthn registrieren</button>
    <button id="loginWebAuthn" type="button">Mit WebAuthn anmelden</button>
  </section>

  <!-- 4. Zeiterfassung -->
  <section id="time-tracking-section" class="card hidden" aria-label="Zeiterfassung">
    <h2>Willkommen, <span id="user-name"></span></h2>
    
    <button id="clock-in-btn" type="button">Einstechen (Start)</button>
    <button id="clock-out-btn" type="button" disabled>Ausstechen (Stop)</button>

    <p id="time-message"></p>

    <button id="logout-btn" type="button" style="margin-top:2rem; background:#e74c3c; color:#fff;">Ausloggen</button>
  </section>

</main>

<button id="theme-switcher" aria-label="Theme wechseln" type="button">üåô</button>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // WebAuthn-Zuweisung
  if (typeof startWebAuthnRegistration === 'function') {
    document.getElementById('registerWebAuthn').onclick = startWebAuthnRegistration;
  }
  if (typeof startWebAuthnLogin === 'function') {
    document.getElementById('loginWebAuthn').onclick = startWebAuthnLogin;
  }

  // Zeitstatus pr√ºfen
  (async () => {
    const token = sessionStorage.getItem('accessToken'); // oder wie du den speicherst
    if (!token) {
      console.warn('‚õî Kein Token gefunden, Statuspr√ºfung √ºbersprungen.');
      return;
    }

    try {
      const status = await getLetzterStatus();
      const clockInBtn = document.getElementById('clockInBtn');
      const clockOutBtn = document.getElementById('clockOutBtn');

      if (clockInBtn && clockOutBtn) {
        if (status?.aktion === 'start') {
          clockInBtn.disabled = true;
          clockOutBtn.disabled = false;
        } else {
          clockInBtn.disabled = false;
          clockOutBtn.disabled = true;
        }
      }
    } catch (err) {
      console.error('‚ùå Fehler beim Abrufen des Status:', err);
    }
  })();
});


  const BASE = '/api';

// DOM-Elemente
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');
const showRegisterBtn = document.getElementById('show-register-btn');
const showLoginBtn = document.getElementById('show-login-btn');
const logoutBtn = document.getElementById('logout-btn');
const activateBiometricBtn = document.getElementById('activate-biometric');
const themeSwitcher = document.getElementById('theme-switcher');
const userNameSpan = document.getElementById('user-name');
const clockInBtn = document.getElementById('clock-in-btn');
const clockOutBtn = document.getElementById('clock-out-btn');

const qrSection = document.getElementById('qr-section');
const loginSection = document.getElementById('login-section');
const registerSection = document.getElementById('register-section');
const timeTrackingSection = document.getElementById('time-tracking-section');
const qrReaderElem = document.getElementById('qr-reader');
const qrMessage = document.getElementById('qr-message');
const loginEmail = document.getElementById('login-email');
const loginPassword = document.getElementById('login-password');
const loginError = document.getElementById('login-error');
// API-Endpunkt (Render-Backend)
const API_BASE = 'https://backend-869x.onrender.com/api';


  
let html5QrCode = null;
let scannedVehicleId = null;
let loggedInUser = null;
let biometricEnabled = false;

// === Hilfsfunktion: CSRF aus Cookie lesen ===
function getCsrfTokenFromCookie() {
  const match = document.cookie.match(/(?:^|;\s*)csrfToken=([^;]+)/);
  return match ? decodeURIComponent(match[1]) : null;
}

const API_BASE_URL = 'https://backend-869x.onrender.com';

async function apiFetch(path, options = {}, useAuthHeaderToken = false) {
  const url = path.startsWith('http') ? path : `${API_BASE_URL}${path}`;
  const method = (options.method || 'GET').toUpperCase();

  // Kopiere headers oder erstelle neues Objekt
  const headers = options.headers ? { ...options.headers } : {};

  options.credentials = 'include';

  if (useAuthHeaderToken) {
    const token = sessionStorage.getItem('accessToken');
    if (!token) throw new Error('Kein Access-Token gefunden. Bitte einloggen.');
    headers['Authorization'] = `Bearer ${token}`;
  }

  if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
    const csrfToken = localStorage.getItem('csrfToken');  // z.B. aus localStorage holen
    if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
  }

  if (options.body && typeof options.body !== 'string') {
    headers['Content-Type'] = 'application/json';
    options.body = JSON.stringify(options.body);
  }

  options.method = method;
  options.headers = headers;

  const response = await fetch(url, options);

  if (!response.ok) {
    let errorText;
    try {
      errorText = await response.text();
    } catch {
      errorText = '';
    }
    throw new Error(errorText || `Fehler: HTTP ${response.status}`);
  }

  try {
    return await response.json();
  } catch {
    return {};
  }
}



  // Hier absolute URL mit Basis-URL bilden
 async function fetchWithRefresh(path, options = {}, useAuthHeaderToken = false) {
  const url = API_BASE_URL + path;

  let res = await fetch(url, options);

  if (res.status === 401 && useAuthHeaderToken) {
    const refreshRes = await fetch(API_BASE_URL + '/api/refresh', {
      method: 'POST',
      credentials: 'include',
    });

    if (refreshRes.ok) {
      const refreshData = await refreshRes.json();
      sessionStorage.setItem('accessToken', refreshData.accessToken);

      options.headers['Authorization'] = `Bearer ${refreshData.accessToken}`;
      res = await fetch(url, options);

      if (res.status === 401) {
        sessionStorage.removeItem('accessToken');
        throw new Error('Token-Refresh fehlgeschlagen. Bitte neu einloggen.');
      }
    } else {
      sessionStorage.removeItem('accessToken');
      throw new Error('Session abgelaufen. Bitte neu einloggen.');
    }
  }

  return res;
}




  

async function tryTokenRefresh() {
  try {
    const res = await fetch(API_BASE + '/refresh', {
      method: 'POST',
      credentials: 'include'
    });
    if (!res.ok) return false;
    return true;
  } catch (err) {
    console.error('Fehler beim Token-Refresh:', err);
    return false;
  }
}


  async function updateProfile() {
  try {
    const res = await apiFetch('/api/me');
    if (!res.ok) throw new Error('Fehler beim Laden des Profils');
    const user = await res.json();
    const userNameElem = document.getElementById('user-name');
    if(userNameElem) userNameElem.textContent = user.vorname || user.email || 'Benutzer';
    showSection(timeTrackingSection);
  } catch(err) {
    console.error('updateProfile Fehler:', err);
  }
}


// === Theme Handling ===
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  themeSwitcher.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', theme);
}
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  setTheme(current === 'dark' ? 'light' : 'dark');
}
(() => {
  const saved = localStorage.getItem('theme');
  if (saved) setTheme(saved);
  else {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(prefersDark ? 'dark' : 'light');
  }
})();
themeSwitcher.addEventListener('click', toggleTheme);

// === Sections anzeigen ===
function showSection(section) {
  [qrSection, loginSection, registerSection, timeTrackingSection].forEach(s => {
    s.classList.add('hidden');
    s.setAttribute('aria-hidden', 'true');
  });
  section.classList.remove('hidden');
  section.setAttribute('aria-hidden', 'false');
}

// === QR Scanner ===
async function startQrScanner() {
  qrMessage.textContent = "Scanne den QR-Code";
  if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");

  try {
    await html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      async (text) => {
        const qrCode = text.trim();
        console.log('üì¶ Gescannter QR:', `"${qrCode}"`, 'L√§nge:', qrCode.length);

        await stopQrScanner(); // Sofort stoppen nach Scan

        qrMessage.textContent = "QR-Code erkannt: " + qrCode;

        // === Hier ist der Codeblock korrekt platziert ===
        try {
          await validateQrCode(qrCode);               // ‚Üí pr√ºft gegen Backend
          scannedVehicleId = qrCode;                  // ‚Üí speichert ID
          const autoLoggedIn = await tryAutoLogin();  // ‚Üí versucht automatischen Login
          if (!autoLoggedIn) showSection(loginSection); // ‚Üí sonst Login anzeigen
        } catch (err) {
          qrMessage.textContent = "Ung√ºltiger QR-Code";
          console.error(err);
        }
      }
    );
  } catch (err) {
    qrMessage.textContent = "Kamera nicht verf√ºgbar.";
    console.error(err);
  }
}

async function stopQrScanner() {
  if (html5QrCode) {
    try {
      await html5QrCode.stop();
    } catch (e) {
      console.warn("Fehler beim Stoppen des QR-Scanners:", e);
    }

    // NICHT html5QrCode.clear() aufrufen ‚Äì das zerst√∂rt das Scanner-Element
    // KEIN innerHTML leeren, sonst ist die Kamera weg
    // qrReaderElem.innerHTML = ""; ‚Üê DAS entfernen!
  }
}



// QR-Code Validierung gegen Backend
async function validateQrCode(qr) {
 const res = await fetch(`${API_BASE}/validate-qr`, {  // nur einmal /api
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ qr }),
});

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || 'Ung√ºltiger QR-Code');
  }
}




// === Auth ===

// Login mit Email/Passwort
async function login(email, passwort) {
  const data = await apiFetch('/api/login', {
    method: 'POST',
    body: { email, passwort }
  });

  console.log('Login response:', data);

  if (!data.user) {
    throw new Error('Keine Benutzerdaten in der Antwort.');
  }

  // AccessToken im sessionStorage speichern
  sessionStorage.setItem('accessToken', data.accessToken);


  // CSRF-Token speichern (wie bisher)
  localStorage.setItem('csrfToken', data.csrfToken);

  loggedInUser = data.user;
  updateUIAfterLogin();

  return loggedInUser;
}





// WebAuthn Registrierung starten
async function startWebAuthnRegistration() {
  try {
    const resp = await apiFetch('/webauthn/register-request', {
      method: 'POST',
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      throw new Error(err.error || 'WebAuthn Registrierung Anfrage fehlgeschlagen');
    }
    const options = await resp.json();

if (!window.PublicKeyCredential) {
  alert('WebAuthn wird von deinem Ger√§t nicht unterst√ºtzt.');
  return;
}
    
    // Challenge und IDs in Uint8Array konvertieren
    options.challenge = base64urlToUint8Array(options.challenge);
    options.user.id = base64urlToUint8Array(options.user.id);
    if (options.excludeCredentials) {
      options.excludeCredentials = options.excludeCredentials.map(cred => ({
        ...cred,
        id: base64urlToUint8Array(cred.id),
      }));
    }

    const credential = await navigator.credentials.create({ publicKey: options });

    const credentialResponse = {
      id: credential.id,
      rawId: toBase64Url(credential.rawId),
      type: credential.type,
      response: {
        attestationObject: toBase64Url(credential.response.attestationObject),
        clientDataJSON: toBase64Url(credential.response.clientDataJSON),
      },
    };

    const verifyResp = await apiFetch('/webauthn/register-response', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentialResponse),
    });

    if (!verifyResp.ok) {
      const err = await verifyResp.json().catch(() => ({}));
      throw new Error(err.error || 'WebAuthn Registrierung fehlgeschlagen');
    }

    return true;
  } catch (err) {
    console.error(err);
    throw err;
  }
}



// WebAuthn Login Anfrage + Antwort
async function loginViaWebAuthn(email) {
  try {
    const res = await apiFetch('/webauthn/login-request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email }),
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'WebAuthn Login-Anfrage fehlgeschlagen');
    }
    const options = await res.json();

    options.challenge = base64urlToUint8Array(options.challenge);
    if (options.allowCredentials) {
      options.allowCredentials = options.allowCredentials.map(cred => ({
        ...cred,
        id: base64urlToUint8Array(cred.id),
      }));
    }

    const assertion = await navigator.credentials.get({ publicKey: options });

    const credential = {
      id: assertion.id,
      rawId: toBase64Url(assertion.rawId),
      type: assertion.type,
      response: {
        authenticatorData: toBase64Url(assertion.response.authenticatorData),
        clientDataJSON: toBase64Url(assertion.response.clientDataJSON),
        signature: toBase64Url(assertion.response.signature),
        userHandle: assertion.response.userHandle ? toBase64Url(assertion.response.userHandle) : null,
      },
    };

    const verifyResp = await apiFetch('/webauthn/login-response', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credential }),
    });
    if (!verifyResp.ok) {
      const err = await verifyResp.json().catch(() => ({}));
      throw new Error(err.error || 'WebAuthn Login fehlgeschlagen');
    }

    const userRes = await apiFetch('/me');
    if (!userRes.ok) throw new Error('Fehler beim Abrufen der Benutzerdaten nach WebAuthn Login');
    return userRes.json();
  } catch (err) {
    console.error(err);
    throw err;
  }
}


async function checkBiometricStatus() {
  try {
   const response = await fetch(API_BASE + '/api/user/biometric-status', {
      method: 'GET',
      credentials: 'include', // sendet Cookies mit
      headers: {
        'Accept': 'application/json',
        // Falls du Token im Header brauchst:
        // 'Authorization': 'Bearer ' + deinToken,
        // 'X-CSRF-Token': deinCSRFToken // falls CSRF-Schutz aktiv
      }
    });

    if (!response.ok) {
      throw new Error(`Fehler: ${response.status}`);
    }

    const data = await response.json();
    console.log('WebAuthn aktiv?', data.biometricEnabled);
    return data.biometricEnabled; // true oder false
  } catch (err) {
    console.error('Fehler beim Abrufen des Biometrie-Status:', err);
    return false;
  }
}


 function showPopupMessage(msg, duration = 3000) {
  const popup = document.getElementById('popup-message');
  popup.textContent = msg;
  popup.classList.remove('hidden');

  setTimeout(() => {
    popup.classList.add('hidden');
  }, duration);
}


// === Helper Funktionen zur Base64-URL-Konvertierung (f√ºr WebAuthn) ===
function base64urlToUint8Array(base64urlString) {
  const padding = '='.repeat((4 - (base64urlString.length % 4)) % 4);
  const base64 = (base64urlString + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

function toBase64Url(buffer) {
  const bytes = new Uint8Array(buffer);
  let str = '';
  for (let i = 0; i < bytes.byteLength; i++) {
    str += String.fromCharCode(bytes[i]);
  }
  return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// === Automatischer Login (z.B. nach QR-Scan) ===
async function tryAutoLogin() {
  const token = sessionStorage.getItem('accessToken');
  if (!token) return false;

  try {
    const res = await apiFetch('/api/me', {}, true); // true = Token-Header mitschicken
    if (!res.ok) {
      sessionStorage.removeItem('accessToken');
      return false;
    }

    loggedInUser = await res.json();
    biometricEnabled = loggedInUser.biometricEnabled || false;
    updateUIAfterLogin();
    return true;
  } catch (err) {
    console.warn('AutoLogin fehlgeschlagen:', err);
    sessionStorage.removeItem('accessToken');
    return false;
  }
}



// === UI Aktualisierung nach Login ===
function updateUIAfterLogin() {
  userNameSpan.textContent = loggedInUser.name || loggedInUser.email || 'Benutzer';

  showSection(timeTrackingSection);
  loginSection.classList.add('hidden');
  registerSection.classList.add('hidden');
  qrSection.classList.add('hidden');
  logoutBtn.classList.remove('hidden');
  activateBiometricBtn.classList.toggle('hidden', biometricEnabled);
}

async function updateTimeButtons() {
  const res = await apiFetch('/zeit/status');
  if (!res.ok) return;
  const data = await res.json();
  clockInBtn.disabled = data.status === 'running';
  clockOutBtn.disabled = data.status !== 'running';
}

// === Logout Cleanup ===
function handleLogoutCleanup() {
  loggedInUser = null;
  scannedVehicleId = null;
  biometricEnabled = false;
  loginEmail.value = '';
  loginPassword.value = '';
  showSection(qrSection);
  logoutBtn.classList.add('hidden');
  activateBiometricBtn.classList.remove('hidden');
  userNameSpan.textContent = '';
  vehicleIdSpan.textContent = '';
}

// === Logout ===
logoutBtn.addEventListener('click', async () => {
  try {
    const res = await apiFetch('/api/logout', { method: 'POST' });

    if (res.ok) {
      handleLogoutCleanup();
    } else {
      alert('Logout fehlgeschlagen');
    }
  } catch (err) {
    console.error(err);
    alert('Logout Fehler');
  }
});



// === Login-Formular ===
loginForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();

  const email = loginForm['email'].value.trim();
  const passwort = loginForm['passwort'].value.trim();

  try {
    await login(email, passwort);
    alert('Login erfolgreich!');
    showSection(timeTrackingSection);
    await updateProfile();
  } catch (err) {
    console.error(err);
    alert(err.message);
  }
});



// === Register-Link im Login-Form ===
showRegisterBtn.addEventListener('click', () => {
  showSection(registerSection);
});

// === Zur√ºck zum Login ===
showLoginBtn.addEventListener('click', () => {
  showSection(loginSection);
});

// === Registrierung ===
registerForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();

  const vorname = registerForm['firstname'].value.trim();
  const nachname = registerForm['lastname'].value.trim();
  const email = registerForm['email'].value.trim();
  const passwort = registerForm['password'].value.trim(); // wichtig: Backend erwartet "passwort"

  try {
    const res = await apiFetch('/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ vorname, nachname, email, passwort }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'Registrierung fehlgeschlagen');
    }

    alert('Registrierung erfolgreich! Bitte einloggen.');
    showSection(loginSection);
  } catch (err) {
    alert(err.message);
  }
});


// === WebAuthn Aktivierung Button ===
activateBiometricBtn.addEventListener('click', async () => {
  activateBiometricBtn.disabled = true;
  try {
    await startWebAuthnRegistration();
    alert('Biometrische Anmeldung aktiviert!');
    biometricEnabled = true;
    activateBiometricBtn.classList.add('hidden');
  } catch (err) {
    alert('WebAuthn Registrierung fehlgeschlagen: ' + err.message);
  } finally {
    activateBiometricBtn.disabled = false;
  }
});


// === Zeit erfassen (Start) ===
clockInBtn.addEventListener('click', async () => {
  if (!loggedInUser) {
    alert('Bitte zuerst einloggen');
    return;
  }

  try {
    const res = await apiFetch('/api/zeit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ aktion: 'start' }),
    }, true); // true = Token im Header mitschicken

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'Start der Zeitbuchung fehlgeschlagen');
    }

    alert('Arbeitszeit gestartet');
  } catch (err) {
    console.error(err);
    alert('Fehler beim Start der Arbeitszeit: ' + err.message);
  }
});


// === Zeit erfassen (Stopp) ===
clockOutBtn.addEventListener('click', async () => {
  if (!loggedInUser) {
    alert('Bitte zuerst einloggen');
    return;
  }

  clockOutBtn.disabled = true;

  try {
    const res = await apiFetch('/zeit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ aktion: 'stop' }),
    }, true);

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'Stop der Zeitbuchung fehlgeschlagen');
    }

    alert('Arbeitszeit gestoppt');
  } catch (err) {
    console.error('Fehler beim Stop:', err);
    alert('Fehler beim Stoppen der Arbeitszeit: ' + err.message);
  } finally {
    clockOutBtn.disabled = false;
  }
});

//schon eingestempelt?
async function getLetzterStatus() {
  try {
    const response = await apiFetch('/api/zeit/letzter-status', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
    }, true); // <-- wichtig: Authentifizierung aktivieren

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.error || `Fehler: ${response.status}`);
    }

    const data = await response.json();
    console.log('Letzter Zeitstatus:', data);
    return data; // z.B. { aktion: 'start', zeit: '2025-06-09T08:00:00Z' }
  } catch (err) {
    console.error('Fehler beim Abrufen des letzten Status:', err);
    return null;
  }
}



// === Initial Setup ===
async function init() {
  showSection(qrSection);
  await startQrScanner();
  await tryAutoLogin();

  // Status pr√ºfen und Buttons entsprechend setzen
  const status = await getLetzterStatus();
  if (status?.aktion === 'start') {
    clockInBtn.disabled = true;
    clockOutBtn.disabled = false;
  } else {
    clockInBtn.disabled = false;
    clockOutBtn.disabled = true;
  }
}
init();

async function fetchUserProfile() {
  const response = await apiFetch('/me');
  if (!response.ok) throw new Error('Benutzerdaten konnten nicht geladen werden');
  const user = await response.json();
  return user;
}
</script>

<script type="module" src="main.js"></script>

</body>
</html>
